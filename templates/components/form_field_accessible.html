{#
=============================================================================
ACCESSIBLE FORM FIELD COMPONENT - Finanpy Design System
=============================================================================

This reusable component renders a fully accessible form field with:
- Proper label association (for/id)
- Help text with aria-describedby
- Error messages with role="alert" and aria-invalid
- Required field indicator with aria-hidden
- Support for custom field types and widgets

Usage:
    {% include "components/form_field_accessible.html" with field=form.field_name %}

Optional parameters:
    - label: Custom label text (default: field.label)
    - help_text: Custom help text (default: field.help_text)
    - tooltip: Tooltip text to display next to label
    - custom_classes: Additional CSS classes for the input
    - prefix: Text prefix to show inside input (e.g., "R$")
    - custom_widget: Render custom HTML widget instead of field widget

=============================================================================
#}

<div class="form-group">
    {# Label with proper association #}
    <label for="{{ field.id_for_label }}" class="block text-sm font-medium text-gray-300 mb-2">
        {% if label %}{{ label }}{% else %}{{ field.label }}{% endif %}
        {% if field.field.required %}
        <span class="text-red-400" aria-hidden="true">*</span>
        {% endif %}
        {% if tooltip %}
        {% include "components/tooltip.html" with text=tooltip %}
        {% endif %}
    </label>

    {# Field input with accessibility attributes #}
    {% if custom_widget %}
        {# Render custom widget HTML if provided #}
        {{ custom_widget|safe }}
    {% elif prefix %}
        {# Render field with prefix (e.g., currency) #}
        <div class="relative">
            <span class="absolute left-4 top-3.5 text-gray-400 font-semibold">{{ prefix }}</span>
            {% with field_attrs=field.field.widget.attrs %}
            <input
                type="{{ field.field.widget.input_type }}"
                name="{{ field.name }}"
                id="{{ field.id_for_label }}"
                value="{% if field.value %}{{ field.value }}{% endif %}"
                class="w-full pl-12 pr-4 py-3 bg-gray-700 border {% if field.errors %}border-red-500{% else %}border-gray-600{% endif %} rounded-lg text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 {% if field.errors %}focus:ring-red-500{% else %}focus:ring-purple-500{% endif %} focus:border-transparent transition-all duration-200 {{ custom_classes }}"
                {% if field.field.widget.attrs.placeholder %}placeholder="{{ field.field.widget.attrs.placeholder }}"{% endif %}
                {% if field.field.required %}required aria-required="true"{% endif %}
                {% if field.errors %}aria-invalid="true" aria-describedby="{% if field.help_text or help_text %}{{ field.id_for_label }}_help {% endif %}{{ field.id_for_label }}_error"{% elif field.help_text or help_text %}aria-describedby="{{ field.id_for_label }}_help"{% endif %}
                {% for attr_name, attr_value in field.field.widget.attrs.items %}
                    {% if attr_name != 'class' and attr_name != 'placeholder' %}{{ attr_name }}="{{ attr_value }}" {% endif %}
                {% endfor %}
            >
            {% endwith %}
        </div>
    {% else %}
        {# Render standard field with accessibility enhancements #}
        {% with field_class=field.field.widget.attrs.class %}
        {% if field.errors %}
            {# Add error styling if field has errors #}
            {{ field|add_class:"border-red-500 focus:ring-red-500"|attr:"aria-invalid:true"|attr:aria_describedby }}
        {% else %}
            {{ field }}
        {% endif %}
        {% endwith %}

        {# Add aria-describedby and aria-invalid via JavaScript if not already set #}
        <script>
            (function() {
                var field = document.getElementById('{{ field.id_for_label }}');
                if (field) {
                    // Set aria-describedby
                    var describedBy = [];
                    {% if field.help_text or help_text %}
                    describedBy.push('{{ field.id_for_label }}_help');
                    {% endif %}
                    {% if field.errors %}
                    describedBy.push('{{ field.id_for_label }}_error');
                    field.setAttribute('aria-invalid', 'true');
                    {% else %}
                    field.setAttribute('aria-invalid', 'false');
                    {% endif %}
                    if (describedBy.length > 0) {
                        field.setAttribute('aria-describedby', describedBy.join(' '));
                    }
                    // Set aria-required
                    {% if field.field.required %}
                    field.setAttribute('aria-required', 'true');
                    {% endif %}
                }
            })();
        </script>
    {% endif %}

    {# Help text with proper ID for aria-describedby #}
    {% if field.help_text or help_text %}
    <p id="{{ field.id_for_label }}_help" class="mt-2 text-xs text-gray-400">
        {% if help_text %}{{ help_text }}{% else %}{{ field.help_text }}{% endif %}
    </p>
    {% endif %}

    {# Error messages with role="alert" #}
    {% if field.errors %}
    <div id="{{ field.id_for_label }}_error" role="alert" class="mt-2">
        {% for error in field.errors %}
        <p class="text-sm text-red-400 flex items-start">
            <svg class="w-4 h-4 mr-1 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            {{ error }}
        </p>
        {% endfor %}
    </div>
    {% endif %}
</div>
